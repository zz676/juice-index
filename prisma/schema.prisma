generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/// Tracks processed Stripe webhook events for idempotency.
model StripeWebhookEvent {
  /// Stripe event ID (e.g. evt_xxx).
  id          String   @id
  /// Event type (e.g. customer.subscription.updated).
  eventType   String
  /// Timestamp when the event was processed.
  processedAt DateTime @default(now())

  @@index([processedAt])
  @@map("juice_stripe_webhook_events")
}

/// Tracks AI usage metrics, costs, and outcomes for text and image generation.
model AIUsage {
  /// Primary identifier for the record.
  id           String   @id @default(cuid())
  /// Type discriminator for the record.
  type         String
  /// Model name or identifier.
  model        String
  /// Size descriptor (for example, dimensions or capacity).
  size         String?
  /// Estimated cost in USD.
  cost         Float
  /// Whether the operation succeeded.
  success      Boolean
  /// Error message for a failed operation.
  errorMsg     String?
  /// Identifier of the related post.
  postId       String?
  /// Source identifier for the record.
  source       String
  /// Timestamp when the record was created.
  createdAt    DateTime @default(now())
  /// Prompt token count for text completions.
  inputTokens  Int?
  /// Completion token count for text completions.
  outputTokens Int?
  /// Request duration in milliseconds.
  durationMs   Int?
  Post         Post?    @relation(fields: [postId], references: [id])

  @@index([createdAt])
  @@index([postId])
  @@index([source])
  @@map("juice_ai_usage")
}

/// Stores OAuth account details linked to a user (provider tokens and metadata).
model Account {
  /// Primary identifier for the record.
  id                String       @id
  /// Identifier of the related user.
  userId            String
  /// Auth or data provider identifier.
  provider          AuthProvider
  /// Provider-specific account identifier.
  providerAccountId String
  /// Access token used for authenticated requests.
  accessToken       String?
  /// Refresh token used to obtain new access tokens.
  refreshToken      String?
  /// Timestamp when the token/session expires.
  expiresAt         Int?
  /// OAuth token type.
  tokenType         String?
  /// OAuth scopes granted for the token.
  scope             String?
  /// Timestamp when the record was created.
  createdAt         DateTime     @default(now())
  /// Timestamp when the record was last updated.
  updatedAt         DateTime
  User              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("juice_accounts")
}

/// Stores scheduled digest posts, their content, and posting metadata.
model DigestContent {
  /// Primary identifier for the record.
  id             String    @id @default(cuid())
  /// Scheduled execution time.
  scheduledFor   DateTime
  /// Body/content text.
  content        String
  /// List of related post identifiers.
  postIds        String[]
  /// Identifier of the primary/top post for this record.
  topPostId      String
  /// Workflow status for the record.
  status         String    @default("PENDING")
  /// Timestamp when the record was posted to X.
  postedAt       DateTime?
  /// X tweet identifier.
  tweetId        String?
  /// Timestamp when the record was created.
  createdAt      DateTime  @default(now())
  /// URL of the generated digest image.
  digestImageUrl String?

  @@index([scheduledFor])
  @@index([status])
  @@map("juice_digest_content")
}

/// Records delivery events for email notifications (open, click, bounce, etc.).
model EmailEvent {
  /// Primary identifier for the record.
  id                String            @id
  /// Identifier of the related notification.
  notificationId    String
  /// Event type value.
  event             EmailEventType
  /// Event timestamp.
  timestamp         DateTime          @default(now())
  /// Raw JSON payload for metadata.
  metadata          Json?
  EmailNotification EmailNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([notificationId])
  @@map("juice_email_events")
}

/// Stores outgoing email notifications and their delivery state.
model EmailNotification {
  /// Primary identifier for the record.
  id         String       @id
  /// Identifier of the related user.
  userId     String
  /// Type discriminator for the record.
  type       EmailType
  /// Subject.
  subject    String
  /// List of related post identifiers.
  postIds    String[]
  /// Workflow status for the record.
  status     EmailStatus  @default(PENDING)
  /// Provider message identifier.
  messageId  String?
  /// Error.
  error      String?
  /// Timestamp for sent.
  sentAt     DateTime?
  /// Timestamp when the record was created.
  createdAt  DateTime     @default(now())
  EmailEvent EmailEvent[]
  User       User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([type, sentAt])
  @@index([userId])
  @@map("juice_email_notifications")
}

/// Stores magic-link tokens used for passwordless authentication.
model MagicLink {
  /// Primary identifier for the record.
  id        String   @id
  /// Email address.
  email     String
  /// One-time token value.
  token     String   @unique
  /// Timestamp when the token/session expires.
  expiresAt DateTime
  /// Whether used is true.
  used      Boolean  @default(false)
  /// Timestamp when the record was created.
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
  @@map("juice_magic_links")
}

/// Primary news post record with source metadata and translated content.
model Post {
  /// Primary identifier for the record.
  id                 String           @id
  /// Source-system identifier for the record.
  sourceId           String           @unique
  /// Source identifier for the record.
  source             Source           @default(OFFICIAL)
  /// Canonical source URL for the record.
  sourceUrl          String
  /// Source author.
  sourceAuthor       String
  /// Timestamp from the original source.
  sourceDate         DateTime
  /// Original (source-language) title.
  originalTitle      String?
  /// Original (source-language) content.
  originalContent    String?
  /// List of original/source media URLs.
  originalMediaUrls  String[]
  /// Translated title.
  translatedTitle    String?
  /// Translated content.
  translatedContent  String?
  /// Translated summary for short-form use.
  translatedSummary  String?
  /// List of category labels.
  categories         String[]
  /// Relevance score used for ranking/auto-approval.
  relevanceScore     Int              @default(0)
  /// Workflow status for the record.
  status             PostStatus       @default(PENDING)
  /// Whether published to x is true.
  publishedToX       Boolean          @default(false)
  /// X post identifier.
  xPostId            String?
  /// Timestamp for x published.
  xPublishedAt       DateTime?
  /// Timestamp when the record was created.
  createdAt          DateTime         @default(now())
  /// Timestamp when the record was last updated.
  updatedAt          DateTime
  /// Timestamp for archived.
  archivedAt         DateTime?
  /// Brand value (Brand).
  brand              Brand            @default(INDUSTRY)
  /// List of topics.
  topics             Topic[]
  /// Timestamp when the record was approved.
  approvedAt         DateTime?
  /// Identifier for digest tweet.
  digestTweetId      String?
  /// Whether included in digest is true.
  includedInDigest   Boolean          @default(false)
  /// Selected card/preview image URL.
  cardImageUrl       String?
  /// Whether published to discord is true.
  publishedToDiscord Boolean?         @default(false)
  /// Timestamp for discord published.
  discordPublishedAt DateTime?
  AIUsage            AIUsage[]
  PostContent        PostContent?
  PostTranslation    PostTranslation?
  SavedPost          SavedPost[]
  XPublication       XPublication?

  @@index([brand])
  @@index([source])
  @@index([status, archivedAt, createdAt(sort: Desc)], map: "idx_post_active_status_date")
  @@index([createdAt, id], map: "idx_post_cursor")
  @@index([status, includedInDigest, approvedAt], map: "idx_post_digest_eligible")
  @@index([status, relevanceScore(sort: Desc), createdAt], map: "idx_post_publish_queue")
}

/// Archive snapshot of posts for historical retention and backfills.
model PostArchive {
  /// Primary identifier for the record.
  id                String    @id
  /// Identifier for original.
  originalId        String
  /// Archive month.
  archiveMonth      String
  /// Source-system identifier for the record.
  sourceId          String
  /// Source identifier for the record.
  source            Source
  /// Canonical source URL for the record.
  sourceUrl         String
  /// Source author.
  sourceAuthor      String
  /// Timestamp from the original source.
  sourceDate        DateTime
  /// Brand value (Brand).
  brand             Brand
  /// List of topics.
  topics            Topic[]
  /// Relevance score used for ranking/auto-approval.
  relevanceScore    Int
  /// Original (source-language) title.
  originalTitle     String?
  /// Original (source-language) content.
  originalContent   String
  /// List of media URLs for the record.
  mediaUrls         String[]
  /// Translated title.
  translatedTitle   String?
  /// Translated content.
  translatedContent String
  /// Translated summary for short-form use.
  translatedSummary String
  /// X tweet identifier.
  tweetId           String?
  /// URL for tweet url.
  tweetUrl          String?
  /// Timestamp when the record was published.
  publishedAt       DateTime?
  /// Numeric value for likes.
  likes             Int       @default(0)
  /// Numeric value for retweets.
  retweets          Int       @default(0)
  /// Numeric value for replies.
  replies           Int       @default(0)
  /// Numeric value for impressions.
  impressions       Int       @default(0)
  /// Timestamp when the record was created.
  createdAt         DateTime
  /// Timestamp for archived.
  archivedAt        DateTime  @default(now())

  @@index([archiveMonth])
  @@index([sourceId])
}

/// Stores long-form post content and structured fields.
model PostContent {
  /// Primary identifier for the record.
  id          String   @id
  /// Identifier of the related post.
  postId      String   @unique
  /// Title text for the record.
  title       String?
  /// Body/content text.
  content     String
  /// List of media URLs for the record.
  mediaUrls   String[]
  /// Content hash.
  contentHash String?
  /// Timestamp when the record was created.
  createdAt   DateTime @default(now())
  /// Timestamp when the record was last updated.
  updatedAt   DateTime
  Post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
}

/// Stores translated variants of post content and summaries.
model PostTranslation {
  /// Primary identifier for the record.
  id           String   @id
  /// Identifier of the related post.
  postId       String   @unique
  /// Title text for the record.
  title        String?
  /// Body/content text.
  content      String
  /// Short summary text.
  summary      String
  /// Translated by.
  translatedBy String?
  /// Timestamp for translated.
  translatedAt DateTime @default(now())
  /// Timestamp when the record was created.
  createdAt    DateTime @default(now())
  /// Timestamp when the record was last updated.
  updatedAt    DateTime
  Post         Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
}

/// Logs publishing activity and errors for auditing and troubleshooting.
model PostingLog {
  /// Primary identifier for the record.
  id        String   @id @default(cuid())
  /// Post type.
  postType  String
  /// X tweet identifier.
  tweetId   String
  /// List of related post identifiers.
  postIds   String[]
  /// Timestamp when the record was created.
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@map("juice_posting_logs")
}

/// User-saved posts for later reading or curation.
model SavedPost {
  /// Primary identifier for the record.
  id      String   @id
  /// Identifier of the related user.
  userId  String
  /// Identifier of the related post.
  postId  String
  /// Timestamp for saved.
  savedAt DateTime @default(now())
  Post    Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  User    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
  @@map("juice_saved_posts")
}

/// User session records for authentication.
model Session {
  /// Primary identifier for the record.
  id           String   @id
  /// Identifier of the related user.
  userId       String
  /// Session token.
  sessionToken String   @unique
  /// Expires.
  expires      DateTime
  /// Timestamp when the record was created.
  createdAt    DateTime @default(now())
  /// Timestamp when the record was last updated.
  updatedAt    DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("juice_sessions")
}

/// Newsletter subscriber profile and delivery preferences.
model Subscriber {
  /// Primary identifier for the record.
  id          String    @id
  /// Email address.
  email       String    @unique
  /// Language value (Language).
  language    Language  @default(EN)
  /// List of category labels.
  categories  String[]
  /// Frequency value (Frequency).
  frequency   Frequency @default(DAILY)
  /// Whether verified is true.
  verified    Boolean   @default(false)
  /// Verify token.
  verifyToken String?
  /// Timestamp when the record was created.
  createdAt   DateTime  @default(now())
  /// Timestamp when the record was last updated.
  updatedAt   DateTime

  @@index([verified])
  @@map("juice_subscribers")
}

/// Application user profile and auth metadata.
model User {
  /// Primary identifier for the record.
  id                String              @id
  /// Email address.
  email             String              @unique
  /// Name.
  name              String?
  /// URL for avatar url.
  avatarUrl         String?
  /// Password hash.
  passwordHash      String?
  /// Whether email verified is true.
  emailVerified     Boolean             @default(false)
  /// Email verify token.
  emailVerifyToken  String?
  /// Timestamp when the record was created.
  createdAt         DateTime            @default(now())
  /// Timestamp when the record was last updated.
  updatedAt         DateTime
  /// Role value (UserRole).
  role              UserRole            @default(USER)
  Account           Account[]
  EmailNotification EmailNotification[]
  SavedPost         SavedPost[]
  Session           Session[]
  UserPreference    UserPreference?
  XAccount          XAccount?
  Notification      Notification[]
  subscriptions     ApiSubscription[]
  apiKeys           ApiKey[]
  userPosts         UserPost[]
  MonitoredAccount  MonitoredAccount[]
  EngagementReply   EngagementReply[]
  FollowingCache    FollowingCache[]
  EngagementConfig  EngagementConfig?
  UserTone          UserTone[]

  @@index([emailVerified])
  @@map("juice_users")
}

/// Per-user content and notification preferences.
model UserPreference {
  /// Primary identifier for the record.
  id              String    @id
  /// Identifier of the related user.
  userId          String    @unique
  /// List of brands.
  brands          Brand[]
  /// List of topics.
  topics          Topic[]
  /// Digest frequency value (Frequency).
  digestFrequency Frequency @default(DAILY)
  /// Whether alerts enabled is true.
  alertsEnabled   Boolean   @default(true)
  /// Numeric value for alert threshold.
  alertThreshold  Int       @default(80)
  /// Language value (Language).
  language        Language  @default(EN)
  /// Timestamp when the record was created.
  createdAt       DateTime  @default(now())
  /// Timestamp when the record was last updated.
  updatedAt       DateTime
  User            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("juice_user_preferences")
}

/// Tracks X (Twitter) publication attempts and outcomes per post.
model XPublication {
  /// Primary identifier for the record.
  id                  String         @id
  /// Identifier of the related post.
  postId              String         @unique
  /// Workflow status for the record.
  status              XPublishStatus @default(PENDING)
  /// X tweet identifier.
  tweetId             String?
  /// URL for tweet url.
  tweetUrl            String?
  /// Timestamp when the record was published.
  publishedAt         DateTime?
  /// Image source value (ImageSource).
  imageSource         ImageSource    @default(NONE)
  /// Identifier for media.
  mediaId             String?
  /// Numeric value for attempts.
  attempts            Int            @default(0)
  /// Last error.
  lastError           String?
  /// Timestamp for next retry.
  nextRetryAt         DateTime?
  /// Numeric value for likes.
  likes               Int            @default(0)
  /// Numeric value for retweets.
  retweets            Int            @default(0)
  /// Numeric value for replies.
  replies             Int            @default(0)
  /// Numeric value for impressions.
  impressions         Int            @default(0)
  /// Timestamp for engagement updated.
  engagementUpdatedAt DateTime?
  /// Timestamp when the record was created.
  createdAt           DateTime       @default(now())
  /// Timestamp when the record was last updated.
  updatedAt           DateTime
  Post                Post           @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([status, nextRetryAt], map: "idx_juice_xpub_pending")
  @@map("juice_x_publications")
}

/// Stores linked X account credentials/configuration for posting.
model XAccount {
  /// Primary identifier for the record.
  id             String   @id @default(cuid())
  /// Identifier of the related user.
  userId         String   @unique
  /// Identifier for x user.
  xUserId        String   @unique
  /// Username/handle value.
  username       String
  /// Human-friendly display name.
  displayName    String?
  /// URL for avatar url.
  avatarUrl      String?
  /// Access token used for authenticated requests.
  accessToken    String
  /// Refresh token used to obtain new access tokens.
  refreshToken   String
  /// Timestamp for token expires.
  tokenExpiresAt DateTime
  /// Whether the user has X Premium (25k char limit vs 280).
  isXPremium     Boolean  @default(false)
  /// Set to true when the refresh token is invalidated; cleared on successful reconnect.
  tokenError     Boolean  @default(false)
  /// Timestamp when the record was created.
  createdAt      DateTime @default(now())
  /// Timestamp when the record was last updated.
  updatedAt      DateTime @updatedAt
  User           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("juice_x_accounts")
}

/// Data-driven metric posts prepared for X publication.
model MetricPost {
  /// Primary identifier for the record.
  id            String           @id @default(cuid())
  /// Post type value (MetricPostType).
  postType      MetricPostType
  /// Calendar year for the record.
  year          Int
  /// Reporting period value for the record.
  period        Int
  /// Brand value (Brand).
  brand         Brand
  /// Body/content text.
  content       String
  /// URL for chart image url.
  chartImageUrl String?
  /// Workflow status for the record.
  status        MetricPostStatus @default(DRAFT)
  /// X tweet identifier.
  tweetId       String?
  /// Timestamp when the record was posted to X.
  postedAt      DateTime?
  /// Raw JSON payload for data snapshot.
  dataSnapshot  Json?
  /// Timestamp when the record was created.
  createdAt     DateTime         @default(now())
  /// Timestamp when the record was last updated.
  updatedAt     DateTime         @updatedAt
  /// Numeric value for attempts.
  attempts      Int              @default(0)
  /// Last error.
  lastError     String?
  /// Timestamp for last attempt.
  lastAttemptAt DateTime?        @db.Timestamptz(6)
  /// Timestamp when the record was approved.
  approvedAt    DateTime?        @db.Timestamptz(6)
  /// Identifier of the approving user or system.
  approvedBy    String?

  @@unique([postType, year, period, brand])
  @@index([year, period])
  @@index([status])
  @@map("MetricPost")
}

/// Normalized EV market metric time series values.
model EVMetric {
  /// Primary identifier for the record.
  id           String           @id @default(cuid())
  /// Brand value (Brand).
  brand        Brand
  /// Metric value (MetricType).
  metric       MetricType
  /// Period type value (PeriodType).
  periodType   PeriodType
  /// Calendar year for the record.
  year         Int
  /// Reporting period value for the record.
  period       Int
  /// Vehicle model.
  vehicleModel String?
  /// Region.
  region       String?
  /// Category.
  category     String?
  /// Data source.
  dataSource   String?
  /// Numeric value for value.
  value        Float
  /// Unit.
  unit         String?
  /// Numeric value for yoy change.
  yoyChange    Float?
  /// Numeric value for mom change.
  momChange    Float?
  /// Numeric value for market share.
  marketShare  Float?
  /// Numeric value for ranking.
  ranking      Int?
  /// Canonical source URL for the record.
  sourceUrl    String?
  /// Source title.
  sourceTitle  String?
  /// Numeric value for confidence.
  confidence   Float            @default(1.0)
  /// Timestamp when the record was created.
  createdAt    DateTime         @default(now())
  /// Timestamp when the record was last updated.
  updatedAt    DateTime         @updatedAt
  sources      EVMetricSource[]

  @@unique([brand, metric, periodType, year, period, vehicleModel, region, category, dataSource])
  @@index([brand])
  @@index([metric])
  @@index([periodType, year, period])
  @@index([year, period])
  @@index([region])
  @@index([vehicleModel])
  @@index([brand, metric, year], map: "idx_brand_metric_year")
  @@map("EVMetric")
}

/// Source metadata for EV metrics (provider, url, coverage).
model EVMetricSource {
  /// Primary identifier for the record.
  id         String   @id @default(cuid())
  /// Identifier of the related metric.
  metricId   String
  /// Source type.
  sourceType String
  /// Raw text.
  rawText    String?
  /// Image URL for the record.
  imageUrl   String?
  /// Raw JSON payload for parse log.
  parseLog   Json?
  /// Timestamp when the record was created.
  createdAt  DateTime @default(now())
  metric     EVMetric @relation(fields: [metricId], references: [id], onDelete: Cascade)

  @@index([metricId])
  @@map("EVMetricSource")
}

/// Raw scraped article content and extraction metadata.
model ScrapedArticle {
  /// Primary identifier for the record.
  id            String       @id @default(cuid())
  /// Canonical source URL for the record.
  sourceUrl     String       @unique
  /// Url hash.
  urlHash       String       @unique
  /// Title text for the record.
  title         String
  /// Short summary text.
  summary       String?
  /// Timestamp when the record was published.
  publishedAt   DateTime?
  /// Preview image.
  previewImage  String?
  /// Workflow status for the record.
  status        ScrapeStatus @default(PENDING)
  /// Article type.
  articleType   String?
  /// Whether needs ocr is true.
  needsOcr      Boolean      @default(false)
  /// Whether ocr completed is true.
  ocrCompleted  Boolean      @default(false)
  /// Raw JSON payload for extracted data.
  extractedData Json?
  /// Numeric value for metrics count.
  metricsCount  Int          @default(0)
  /// Numeric value for specs count.
  specsCount    Int          @default(0)
  /// Error message.
  errorMessage  String?
  /// Numeric value for retry count.
  retryCount    Int          @default(0)
  /// Timestamp for scraped.
  scrapedAt     DateTime     @default(now())
  /// Timestamp for processed.
  processedAt   DateTime?
  /// Timestamp when the record was last updated.
  updatedAt     DateTime     @updatedAt
  /// Month number (1-12).
  month         Int?
  /// Calendar year for the record.
  year          Int?

  @@index([status])
  @@index([scrapedAt])
  @@index([articleType])
  @@index([month, year])
}

/// Vehicle specification records for EV models.
model VehicleSpec {
  /// Primary identifier for the record.
  id                 String              @id @default(cuid())
  /// Brand value (Brand).
  brand              Brand
  /// Model name or identifier.
  model              String
  /// Variant.
  variant            String
  /// Launch date.
  launchDate         String?
  /// Vehicle type value (VehicleType).
  vehicleType        VehicleType?
  /// Segment.
  segment            String?
  /// Numeric value for starting price.
  startingPrice      Float?
  /// Numeric value for current price.
  currentPrice       Float?
  /// Numeric value for length mm.
  lengthMm           Int?
  /// Numeric value for width mm.
  widthMm            Int?
  /// Numeric value for height mm.
  heightMm           Int?
  /// Numeric value for wheelbase mm.
  wheelbaseMm        Int?
  /// Numeric value for acceleration.
  acceleration       Float?
  /// Numeric value for top speed.
  topSpeed           Int?
  /// Numeric value for motor power kw.
  motorPowerKw       Int?
  /// Numeric value for motor torque nm.
  motorTorqueNm      Int?
  /// Numeric value for battery capacity.
  batteryCapacity    Float?
  /// Numeric value for range cltc.
  rangeCltc          Int?
  /// Numeric value for range wltp.
  rangeWltp          Int?
  /// Numeric value for range epa.
  rangeEpa           Int?
  /// Numeric value for fuel tank volume.
  fuelTankVolume     Float?
  /// Numeric value for engine displacement.
  engineDisplacement Float?
  /// Numeric value for max charging power.
  maxChargingPower   Int?
  /// Numeric value for charging time10 to80.
  chargingTime10To80 Int?
  /// Canonical source URL for the record.
  sourceUrl          String?
  /// Numeric value for confidence.
  confidence         Float               @default(1.0)
  /// Timestamp when the record was created.
  createdAt          DateTime            @default(now())
  /// Timestamp when the record was last updated.
  updatedAt          DateTime            @updatedAt
  sources            VehicleSpecSource[]

  @@unique([brand, model, variant])
  @@index([brand])
  @@index([model])
  @@index([vehicleType])
  @@index([brand, segment])
  @@map("VehicleSpec")
}

/// Source metadata for vehicle specification data.
model VehicleSpecSource {
  /// Primary identifier for the record.
  id         String      @id @default(cuid())
  /// Identifier of the related spec.
  specId     String
  /// Source type.
  sourceType String
  /// Raw text.
  rawText    String?
  /// Image URL for the record.
  imageUrl   String?
  /// Raw JSON payload for parse log.
  parseLog   Json?
  /// Timestamp when the record was created.
  createdAt  DateTime    @default(now())
  spec       VehicleSpec @relation(fields: [specId], references: [id], onDelete: Cascade)

  @@index([specId])
  @@map("VehicleSpecSource")
}

/// Monthly China passenger car inventory levels from CPCA (China Passenger Car Association).
/// Tracks total inventory at dealerships and manufacturers across China.
/// Used to monitor supply-demand balance in China's automotive market.
/// Data frequency: Monthly
/// Primary source: CPCA reports
/// Use case: Analyze inventory trends, predict production adjustments, assess market health
model ChinaPassengerInventory {
  /// Primary identifier for the record.
  id          String    @id @default(cuid())
  /// Calendar year for the record.
  year        Int
  /// Month number (1-12).
  month       Int
  /// Numeric value for value.
  value       Float
  /// Unit.
  unit        String    @default("million_units")
  /// Description.
  description String?
  /// Canonical source URL for the record.
  sourceUrl   String
  /// Source title.
  sourceTitle String
  /// Image URL for the record.
  imageUrl    String?
  /// Timestamp when the record was created.
  createdAt   DateTime  @default(now())
  /// Timestamp when the record was last updated.
  updatedAt   DateTime  @updatedAt
  /// Timestamp when the record was published.
  publishedAt DateTime?

  @@unique([year, month])
  @@index([year, month])
  @@map("ChinaPassengerInventory")
}

/// Monthly China power battery installation and production data.
/// Tracks batteries installed in EVs (installation) and total production by Chinese battery industry.
/// Installation typically differs from production as batteries may be exported or stockpiled.
/// Data frequency: Monthly
/// Primary source: CABIA (China Automotive Battery Innovation Alliance)
/// Use case: Track EV adoption, battery industry growth, supply chain dynamics
model ChinaBatteryInstallation {
  /// Primary identifier for the record.
  id           String    @id @default(cuid())
  /// Calendar year for the record.
  year         Int
  /// Month number (1-12).
  month        Int
  /// Numeric value for installation.
  installation Float
  /// Numeric value for production.
  production   Float?
  /// Unit.
  unit         String    @default("GWh")
  /// Description.
  description  String?
  /// Canonical source URL for the record.
  sourceUrl    String
  /// Source title.
  sourceTitle  String
  /// Image URL for the record.
  imageUrl     String?
  /// Timestamp when the record was created.
  createdAt    DateTime  @default(now())
  /// Timestamp when the record was last updated.
  updatedAt    DateTime  @updatedAt
  /// Timestamp when the record was published.
  publishedAt  DateTime?

  @@unique([year, month])
  @@index([year, month])
  @@map("ChinaBatteryInstallation")
}

/// Monthly NEV (New Energy Vehicle) sales statistics from CAAM.
/// CAAM (China Association of Automobile Manufacturers) is the official industry body.
/// CAAM data typically includes both domestic sales and exports, representing total production sold.
/// Data frequency: Monthly
/// Primary source: CAAM official releases
/// Use case: Track total NEV market size, compare with CPCA retail data
model CaamNevSales {
  /// Primary identifier for the record.
  id          String    @id @default(cuid())
  /// Calendar year for the record.
  year        Int
  /// Month number (1-12).
  month       Int
  /// Numeric value for value.
  value       Float
  /// Unit.
  unit        String    @default("vehicles")
  /// Numeric value for yoy change.
  yoyChange   Float?
  /// Numeric value for mom change.
  momChange   Float?
  /// Description.
  description String?
  /// Canonical source URL for the record.
  sourceUrl   String
  /// Source title.
  sourceTitle String
  /// Image URL for the record.
  imageUrl    String?
  /// Timestamp when the record was created.
  createdAt   DateTime  @default(now())
  /// Timestamp when the record was last updated.
  updatedAt   DateTime  @updatedAt
  /// Timestamp when the record was published.
  publishedAt DateTime?

  @@unique([year, month])
  @@index([year, month])
  @@map("CaamNevSales")
}

/// Monthly dealer inventory coefficient (库存系数) for China's auto market.
/// The inventory coefficient represents months of inventory at dealerships.
/// Interpretation: 1.0 = 1 month of stock, 1.5+ = oversupply/weak demand, <0.8 = shortage/strong demand
/// Healthy range is typically 0.8-1.2. Above 1.5 signals market pressure on dealers.
/// Data frequency: Monthly
/// Primary source: China Automobile Dealers Association (CADA)
/// Use case: Assess dealer health, predict pricing pressure, market demand signals
model ChinaDealerInventoryFactor {
  /// Primary identifier for the record.
  id          String    @id @default(cuid())
  /// Calendar year for the record.
  year        Int
  /// Month number (1-12).
  month       Int
  /// Numeric value for value.
  value       Float
  /// Unit.
  unit        String    @default("ratio")
  /// Description.
  description String?
  /// Canonical source URL for the record.
  sourceUrl   String
  /// Source title.
  sourceTitle String
  /// Image URL for the record.
  imageUrl    String?
  /// Timestamp when the record was created.
  createdAt   DateTime  @default(now())
  /// Timestamp when the record was last updated.
  updatedAt   DateTime  @updatedAt
  /// Timestamp when the record was published.
  publishedAt DateTime?

  @@unique([year, month])
  @@index([year, month])
  @@map("ChinaDealerInventoryFactor")
}

/// Monthly NEV retail sales from CPCA (China Passenger Car Association).
/// Retail sales = units sold to end consumers (registered for road use).
/// Differs from wholesale: retail reflects actual consumer demand, wholesale reflects dealer orders.
/// CPCA data focuses on passenger vehicles; excludes commercial vehicles.
/// Data frequency: Monthly
/// Primary source: CPCA official releases
/// Use case: Track consumer EV adoption, compare with wholesale to assess channel inventory
model CpcaNevRetail {
  /// Primary identifier for the record.
  id          String    @id @default(cuid())
  /// Calendar year for the record.
  year        Int
  /// Month number (1-12).
  month       Int
  /// Numeric value for value.
  value       Float
  /// Unit.
  unit        String    @default("vehicles")
  /// Numeric value for yoy change.
  yoyChange   Float?
  /// Numeric value for mom change.
  momChange   Float?
  /// Description.
  description String?
  /// Canonical source URL for the record.
  sourceUrl   String
  /// Source title.
  sourceTitle String
  /// Image URL for the record.
  imageUrl    String?
  /// Timestamp when the record was created.
  createdAt   DateTime  @default(now())
  /// Timestamp when the record was last updated.
  updatedAt   DateTime  @updatedAt
  /// Timestamp when the record was published.
  publishedAt DateTime?

  @@unique([year, month])
  @@index([year, month])
  @@map("CpcaNevRetail")
}

/// Monthly NEV production volume from CPCA (China Passenger Car Association).
/// Production = units manufactured by automakers during the month.
/// Production typically leads sales data; comparing production vs sales shows inventory build/draw.
/// CPCA data focuses on passenger vehicles; excludes commercial vehicles.
/// Data frequency: Monthly
/// Primary source: CPCA official releases
/// Use case: Track manufacturing output, predict future supply, compare with sales
model CpcaNevProduction {
  /// Primary identifier for the record.
  id          String    @id @default(cuid())
  /// Calendar year for the record.
  year        Int
  /// Month number (1-12).
  month       Int
  /// Numeric value for value.
  value       Float
  /// Unit.
  unit        String    @default("vehicles")
  /// Numeric value for yoy change.
  yoyChange   Float?
  /// Numeric value for mom change.
  momChange   Float?
  /// Description.
  description String?
  /// Canonical source URL for the record.
  sourceUrl   String
  /// Source title.
  sourceTitle String
  /// Image URL for the record.
  imageUrl    String?
  /// Timestamp when the record was created.
  createdAt   DateTime  @default(now())
  /// Timestamp when the record was last updated.
  updatedAt   DateTime  @updatedAt
  /// Timestamp when the record was published.
  publishedAt DateTime?

  @@unique([year, month])
  @@index([year, month])
  @@map("CpcaNevProduction")
}

/// Monthly Vehicle Inventory Alert Index (汽车经销商库存预警指数) - market health indicator.
/// The VIA Index works like PMI: >50% indicates contraction/pessimism, <50% indicates expansion/optimism.
/// Interpretation: 50% = neutral, 60%+ = significant dealer stress, <45% = healthy/optimistic market
/// This is a sentiment and inventory pressure indicator surveyed from dealers.
/// Data frequency: Monthly
/// Primary source: China Automobile Dealers Association (CADA)
/// Use case: Gauge dealer confidence, predict market trends, assess inventory pressure
model ChinaViaIndex {
  /// Primary identifier for the record.
  id          String    @id @default(cuid())
  /// Calendar year for the record.
  year        Int
  /// Month number (1-12).
  month       Int
  /// Numeric value for value.
  value       Float
  /// Unit.
  unit        String    @default("percent")
  /// Description.
  description String?
  /// Canonical source URL for the record.
  sourceUrl   String
  /// Source title.
  sourceTitle String
  /// Image URL for the record.
  imageUrl    String?
  /// Timestamp when the record was created.
  createdAt   DateTime  @default(now())
  /// Timestamp when the record was last updated.
  updatedAt   DateTime  @updatedAt
  /// Timestamp when the record was published.
  publishedAt DateTime?

  @@unique([year, month])
  @@index([year, month])
  @@map("ChinaViaIndex")
}

/// Monthly battery data by specific battery maker (individual company performance).
/// Tracks installation and production volumes for major battery manufacturers.
/// Major makers: CATL, BYD, LG Energy Solution, SK On, Panasonic, CALB, Gotion (Guoxuan), EVE, Sunwoda
/// Data frequency: Monthly
/// Primary source: CABIA (China), SNE Research (Global)
/// Use case: Track individual battery company performance, market share trends, competitive analysis
model BatteryMakerMonthly {
  /// Primary identifier for the record.
  id           String    @id @default(cuid())
  /// Maker.
  maker        String
  /// Calendar year for the record.
  year         Int
  /// Month number (1-12).
  month        Int
  /// Numeric value for installation.
  installation Float
  /// Numeric value for production.
  production   Float?
  /// Unit.
  unit         String    @default("GWh")
  /// Numeric value for yoy change.
  yoyChange    Float?
  /// Numeric value for mom change.
  momChange    Float?
  /// Description.
  description  String?
  /// Canonical source URL for the record.
  sourceUrl    String
  /// Source title.
  sourceTitle  String
  /// Image URL for the record.
  imageUrl     String?
  /// Timestamp when the record was created.
  createdAt    DateTime  @default(now())
  /// Timestamp when the record was last updated.
  updatedAt    DateTime  @updatedAt
  /// Timestamp when the record was published.
  publishedAt  DateTime?

  @@unique([maker, year, month])
  @@index([maker])
  @@index([year, month])
  @@map("BatteryMakerMonthly")
}

/// Monthly export data by manufacturing plant (factory-level exports).
/// Tracks vehicles exported from specific manufacturing facilities.
/// Key plants: Tesla Gigafactory Shanghai, BYD Shenzhen, NIO Hefei, etc.
/// Useful for understanding export hub performance and regional production strategy.
/// Data frequency: Monthly
/// Primary source: China Customs, company announcements
/// Use case: Track export performance by plant, supply chain analysis, regional production trends
model PlantExports {
  /// Primary identifier for the record.
  id          String    @id @default(cuid())
  /// Plant.
  plant       String
  /// Brand.
  brand       String
  /// Calendar year for the record.
  year        Int
  /// Month number (1-12).
  month       Int
  /// Numeric value for value.
  value       Float
  /// Unit.
  unit        String    @default("vehicles")
  /// Numeric value for yoy change.
  yoyChange   Float?
  /// Numeric value for mom change.
  momChange   Float?
  /// Description.
  description String?
  /// Canonical source URL for the record.
  sourceUrl   String
  /// Source title.
  sourceTitle String
  /// Image URL for the record.
  imageUrl    String?
  /// Timestamp when the record was created.
  createdAt   DateTime  @default(now())
  /// Timestamp when the record was last updated.
  updatedAt   DateTime  @updatedAt
  /// Timestamp when the record was published.
  publishedAt DateTime?

  @@unique([plant, year, month])
  @@index([plant])
  @@index([brand])
  @@index([year, month])
  @@map("PlantExports")
}

/// NEV sales summary for a specific date range (typically weekly or bi-weekly reports).
/// CPCA releases weekly sales estimates during the month before full monthly data.
/// Contains both retail (to consumers) and wholesale (to dealers) figures for comparison.
/// Retail-wholesale gap indicates channel inventory changes.
/// Data frequency: Weekly or bi-weekly
/// Primary source: CPCA weekly flash reports
/// Use case: Early month-to-date sales tracking, weekly trends, retail vs wholesale analysis
model NevSalesSummary {
  /// Primary identifier for the record.
  id             String    @id @default(cuid())
  /// Data source.
  dataSource     String    @default("CPCA")
  /// Calendar year for the record.
  year           Int
  /// Start date.
  startDate      String
  /// End date.
  endDate        String
  /// Numeric value for retail sales.
  retailSales    Float
  /// Numeric value for retail yoy.
  retailYoy      Float?
  /// Numeric value for retail mom.
  retailMom      Float?
  /// Numeric value for wholesale sales.
  wholesaleSales Float?
  /// Numeric value for wholesale yoy.
  wholesaleYoy   Float?
  /// Numeric value for wholesale mom.
  wholesaleMom   Float?
  /// Unit.
  unit           String    @default("vehicles")
  /// Description.
  description    String?
  /// Canonical source URL for the record.
  sourceUrl      String
  /// Source title.
  sourceTitle    String
  /// Image URL for the record.
  imageUrl       String?
  /// Timestamp when the record was created.
  createdAt      DateTime  @default(now())
  /// Timestamp when the record was last updated.
  updatedAt      DateTime  @updatedAt
  /// Timestamp when the record was published.
  publishedAt    DateTime?

  @@unique([dataSource, year, startDate, endDate])
  @@index([year])
  @@map("NevSalesSummary")
}

/// Monthly automaker sales rankings (top-selling car manufacturers).
/// Tracks competitive positioning of major automakers in China's auto market.
/// Rankings may be for overall sales or NEV-specific depending on the source article.
/// Major automakers: BYD, Geely, SAIC, Changan, GAC, Great Wall, NIO, Xpeng, Li Auto, etc.
/// Data frequency: Monthly
/// Primary source: CPCA (passenger), CAAM (all vehicles)
/// Use case: Competitive analysis, market share tracking, brand performance comparison
model AutomakerRankings {
  /// Primary identifier for the record.
  id          String    @id @default(cuid())
  /// Data source.
  dataSource  String    @default("CPCA")
  /// Calendar year for the record.
  year        Int
  /// Month number (1-12).
  month       Int
  /// Numeric value for ranking.
  ranking     Int
  /// Automaker.
  automaker   String
  /// Numeric value for value.
  value       Float
  /// Unit.
  unit        String    @default("vehicles")
  /// Numeric value for yoy change.
  yoyChange   Float?
  /// Numeric value for mom change.
  momChange   Float?
  /// Numeric value for market share.
  marketShare Float?
  /// Description.
  description String?
  /// Canonical source URL for the record.
  sourceUrl   String
  /// Source title.
  sourceTitle String
  /// Image URL for the record.
  imageUrl    String?
  /// Timestamp when the record was created.
  createdAt   DateTime  @default(now())
  /// Timestamp when the record was last updated.
  updatedAt   DateTime  @updatedAt
  /// Timestamp when the record was published.
  publishedAt DateTime?

  @@unique([dataSource, year, month, automaker])
  @@index([dataSource])
  @@index([automaker])
  @@index([year, month])
  @@map("AutomakerRankings")
}

/// Battery maker rankings (top battery manufacturers by market share).
/// Tracks competitive positioning in both China domestic and global battery markets.
/// China market dominated by CATL, BYD; global includes LG, SK, Panasonic, Samsung SDI.
/// Can be monthly snapshots, year-to-date (YTD), or yearly totals.
/// Data frequency: Monthly, quarterly, or yearly
/// Primary source: CABIA (China domestic), SNE Research (Global)
/// Use case: Battery industry competitive analysis, supply chain understanding, market share trends
model BatteryMakerRankings {
  /// Primary identifier for the record.
  id               String    @id @default(cuid())
  /// Data source.
  dataSource       String
  /// OAuth scopes granted for the token.
  scope            String
  /// Period type.
  periodType       String    @default("MONTHLY")
  /// Calendar year for the record.
  year             Int
  /// Month number (1-12).
  month            Int?
  /// Numeric value for ranking.
  ranking          Int
  /// Maker.
  maker            String
  /// Numeric value for value.
  value            Float
  /// Unit.
  unit             String    @default("GWh")
  /// Numeric value for yoy change.
  yoyChange        Float?
  /// Numeric value for market share.
  marketShare      Float?
  /// Numeric value for share vs prev month.
  shareVsPrevMonth Float?
  /// Description.
  description      String?
  /// Canonical source URL for the record.
  sourceUrl        String
  /// Source title.
  sourceTitle      String
  /// Image URL for the record.
  imageUrl         String?
  /// Timestamp when the record was created.
  createdAt        DateTime  @default(now())
  /// Timestamp when the record was last updated.
  updatedAt        DateTime  @updatedAt
  /// Timestamp when the record was published.
  publishedAt      DateTime?

  @@unique([dataSource, scope, year, month, maker])
  @@index([dataSource, scope])
  @@index([maker])
  @@index([year, month])
  @@map("BatteryMakerRankings")
}

/// NIO power infrastructure snapshot metrics over time.
model NioPowerSnapshot {
  /// Primary identifier for the record.
  id                     String   @id @default(cuid())
  /// As of time.
  asOfTime               DateTime @unique
  /// Numeric value for total stations.
  totalStations          Int
  /// Numeric value for swap stations.
  swapStations           Int
  /// Numeric value for highway swap stations.
  highwaySwapStations    Int
  /// Numeric value for cumulative swaps.
  cumulativeSwaps        BigInt
  /// Numeric value for charging stations.
  chargingStations       Int
  /// Numeric value for charging piles.
  chargingPiles          Int
  /// Numeric value for cumulative charges.
  cumulativeCharges      BigInt
  /// Numeric value for third party piles.
  thirdPartyPiles        Int
  /// Numeric value for third party usage percent.
  thirdPartyUsagePercent Float
  /// Timestamp when the record was created.
  createdAt              DateTime @default(now())
  /// Timestamp when the record was last updated.
  updatedAt              DateTime @updatedAt

  @@index([asOfTime])
  @@index([createdAt])
  @@map("NioPowerSnapshot")
}

enum AuthProvider {
  GOOGLE
  GITHUB
  X
}

enum Brand {
  BYD
  NIO
  XPENG
  LI_AUTO
  ZEEKR
  XIAOMI
  TESLA_CHINA
  OTHER_BRAND
  INDUSTRY
  LEAPMOTOR
  GEELY
}

enum EmailEventType {
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  COMPLAINED
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}

enum EmailType {
  DIGEST
  ALERT
  WELCOME
  VERIFY
}

enum Frequency {
  DAILY
  WEEKLY
  NONE
}

enum ImageSource {
  SCRAPED
  AI_GENERATED
  NONE
  FAILED
}

enum Language {
  EN
  ZH
}

enum PostStatus {
  PENDING
  APPROVED
  PUBLISHED
  REJECTED
}

enum Source {
  OFFICIAL
  MEDIA
  WEIBO
  MANUAL
}

enum Topic {
  DELIVERY
  EARNINGS
  LAUNCH
  TECHNOLOGY
  CHARGING
  POLICY
  EXPANSION
  RECALL
  PARTNERSHIP
  EXECUTIVE
  OTHER
}

enum UserRole {
  USER
  ADMIN
}

enum XPublishStatus {
  PENDING
  PUBLISHING
  PUBLISHED
  FAILED
  SKIPPED
}

enum MetricPostType {
  BRAND_TREND
  ALL_BRANDS_COMPARISON
}

enum MetricPostStatus {
  PENDING
  POSTED
  FAILED
  DRAFT
  APPROVED
  POSTING
  SKIPPED
}

enum MetricType {
  DELIVERY
  SALES
  WHOLESALE
  PRODUCTION
  BATTERY_INSTALL
  REVENUE
  MARKET_SHARE
  RANKING
  IMPORTS
  EXPORTS
  REGISTRATIONS
  DEALER_INVENTORY
}

enum PeriodType {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum VehicleType {
  BEV
  EREV
  PHEV
  HEV
}

enum ScrapeStatus {
  SUCCESS
  SKIPPED_DUPLICATE
  SKIPPED_NO_DATA
  SKIPPED_PAYWALL
  FAILED
  PENDING
}

enum ReplyTone {
  HUMOR
  SARCASTIC
  HUGE_FAN
  CHEERS
  NEUTRAL
  PROFESSIONAL
}

enum EngagementReplyStatus {
  PENDING
  GENERATING
  POSTING
  POSTED
  FAILED
  SKIPPED
  SENT_TO_TELEGRAM
  DISCARDED
}

model ApiKey {
  id                String    @id @default(cuid())
  userId            String
  name              String?
  keyPrefix         String
  keyHash           String    @unique
  isActive          Boolean   @default(true)
  revokedAt         DateTime?
  expiresAt         DateTime?
  rateLimitOverride Int?
  tierOverride      String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  User              User      @relation(fields: [userId], references: [id])
  ApiRequestLog     ApiRequestLog[]

  @@index([keyHash])
  @@index([userId])
  @@map("juice_api_keys")
}

model ApiRequestLog {
  id             String   @id @default(cuid())
  apiKeyId       String?
  userId         String
  endpoint       String
  method         String
  statusCode     Int
  durationMs     Int?
  requestId      String?
  tierAtRequest  String?
  createdAt      DateTime @default(now())

  ApiKey         ApiKey?  @relation(fields: [apiKeyId], references: [id])

  @@index([apiKeyId])
  @@index([userId])
  @@index([createdAt])
  @@map("juice_api_request_logs")
}

model ApiSubscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  stripeCustomerId     String?
  stripeSubscriptionId String?
  tier                 String    @default("FREE")
  status               String    @default("active")
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  User                 User      @relation(fields: [userId], references: [id])
  @@map("juice_api_subscriptions")
}

/// User-authored posts for publishing to X (Twitter).
model UserPost {
  id           String         @id @default(cuid())
  userId       String
  content      String
  status       UserPostStatus @default(DRAFT)
  scheduledFor DateTime?
  publishedAt  DateTime?
  tweetId      String?
  tweetUrl     String?
  lastError    String?
  attempts     Int            @default(0)
  imageBase64  String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  User         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([status, scheduledFor])
  @@index([userId, createdAt(sort: Desc)])
  @@map("juice_user_posts")
}

enum UserPostStatus {
  DRAFT
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
}

enum NotificationType {
  DIGEST_READY
  ALERT
  WELCOME
  SYSTEM
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  User      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, read])
  @@map("juice_notifications")
}

/// X account followed/monitored for engagement auto-replies.
model MonitoredAccount {
  /// Primary identifier for the record.
  id                  String            @id @default(cuid())
  /// Identifier of the related user.
  userId              String
  /// X user identifier of the monitored account.
  xUserId             String
  /// Username/handle of the monitored account.
  username            String
  /// Human-friendly display name.
  displayName         String?
  /// URL for avatar.
  avatarUrl           String?
  /// Reply tone to use for this account.
  tone                ReplyTone         @default(NEUTRAL)
  /// Optional custom tone prompt override.
  customTonePrompt    String?
  /// Percentage (0–100) of replies that should include a generated image. 0 = disabled.
  imageFrequency      Int               @default(0)
  /// Whether auto-reply is enabled for this account.
  enabled             Boolean           @default(true)
  /// Whether replies should be auto-posted to X (true) or sent to Telegram for manual posting (false).
  autoPost            Boolean           @default(false)
  /// Last tweet ID seen from this account (for polling).
  lastSeenTweetId     String?
  /// Timestamp when the account was last polled.
  lastCheckedAt       DateTime?
  /// Free-text description of the account for personalization context.
  accountContext      String?
  /// Weighted tone map: { userToneId: weight }. Null = use legacy tone field.
  toneWeights         Json?
  /// Per-account temperature for reply generation.
  temperature         Float             @default(0.8)
  /// How often (in minutes) to poll this account. Defaults to every 5 minutes.
  pollInterval        Int               @default(5)
  /// Timestamp when the record was created.
  createdAt           DateTime          @default(now())
  /// Timestamp when the record was last updated.
  updatedAt           DateTime          @updatedAt
  User                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  EngagementReply     EngagementReply[]

  @@unique([userId, xUserId])
  @@index([userId])
  @@index([enabled])
  @@map("juice_monitored_accounts")
}

/// Auto-generated reply to a monitored account's tweet.
model EngagementReply {
  /// Primary identifier for the record.
  id                  String                @id @default(cuid())
  /// Identifier of the related user.
  userId              String
  /// Identifier of the monitored account that triggered this reply.
  monitoredAccountId  String
  /// X tweet ID that was replied to.
  sourceTweetId       String
  /// Text content of the source tweet.
  sourceTweetText     String?
  /// URL of the source tweet.
  sourceTweetUrl      String?
  /// Timestamp when the source tweet was published on X.
  sourceTweetCreatedAt DateTime?
  /// Generated reply text.
  replyText           String?
  /// URL of the generated reply image.
  replyImageUrl       String?
  /// Tone used for this reply (legacy enum, kept for existing records).
  tone                ReplyTone
  /// UserTone id used for this reply (new system).
  userToneId          String?
  /// Snapshot of the tone name at generation time.
  userToneName        String?
  /// Workflow status for the record.
  status              EngagementReplyStatus @default(PENDING)
  /// X tweet ID of the posted reply.
  replyTweetId        String?
  /// URL of the posted reply on X.
  replyTweetUrl       String?
  /// Error message if the reply failed.
  lastError           String?
  /// Number of posting attempts.
  attempts            Int                   @default(0)
  /// AI text generation cost in USD.
  textGenerationCost  Float                 @default(0)
  /// Image generation cost in USD.
  imageGenerationCost Float                 @default(0)
  /// X API call cost in USD.
  apiCallCost         Float                 @default(0)
  /// Total cost in USD.
  totalCost           Float                 @default(0)
  /// Timestamp when the record was created.
  createdAt           DateTime              @default(now())
  /// Timestamp when the record was last updated.
  updatedAt           DateTime              @updatedAt
  User                User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  MonitoredAccount    MonitoredAccount      @relation(fields: [monitoredAccountId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@index([monitoredAccountId])
  @@map("juice_engagement_replies")
}

/// Cache of X accounts that a user follows (for the monitored account picker).
model FollowingCache {
  /// Primary identifier for the record.
  id          String   @id @default(cuid())
  /// Identifier of the related user.
  userId      String
  /// X user identifier of the followed account.
  xUserId     String
  /// Username/handle of the followed account.
  username    String
  /// Human-friendly display name.
  displayName String?
  /// URL for avatar.
  avatarUrl   String?
  /// Timestamp when the record was created.
  createdAt   DateTime @default(now())
  /// Timestamp when the record was last updated.
  updatedAt   DateTime @updatedAt
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, xUserId])
  @@index([userId])
  @@map("juice_following_cache")
}

/// Global engagement auto-reply configuration per user.
model EngagementConfig {
  /// Primary identifier for the record.
  id           String   @id @default(cuid())
  /// Identifier of the related user.
  userId       String   @unique
  /// Whether all auto-replies are globally paused.
  globalPaused Boolean  @default(false)
  /// Timestamp when the record was created.
  createdAt    DateTime @default(now())
  /// Timestamp when the record was last updated.
  updatedAt    DateTime @updatedAt
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("juice_engagement_configs")
}

/// Per-user editable tone definitions for engagement reply generation.
model UserTone {
  /// Primary identifier for the record.
  id        String   @id @default(cuid())
  /// Identifier of the related user.
  userId    String
  /// Display name for the tone (e.g. "Humor", "My Custom Tone").
  name      String
  /// Full system prompt text for this tone.
  prompt    String   @db.Text
  /// UI color key: slate, blue, yellow, orange, pink, green, purple, teal.
  color     String   @default("slate")
  /// Timestamp when the record was created.
  createdAt DateTime @default(now())
  /// Timestamp when the record was last updated.
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@map("juice_user_tones")
}

/// LEGACY MODELS (Preserved to prevent dropping tables used by external project)

model LegacyAIUsage {
  id           String   @id @default(cuid())
  type         String
  model        String
  size         String?
  cost         Float
  success      Boolean
  errorMsg     String?
  postId       String?
  source       String
  createdAt    DateTime @default(now())
  inputTokens  Int?
  outputTokens Int?
  durationMs   Int?
  
  @@index([createdAt])
  @@index([postId])
  @@index([source])
  @@map("AIUsage")
  @@ignore
}

model LegacyAccount {
  id                String       @id
  userId            String
  provider          AuthProvider
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         Int?
  tokenType         String?
  scope             String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime
  User              LegacyUser   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("Account")
  @@ignore
}

model LegacyDigestContent {
  id             String    @id @default(cuid())
  scheduledFor   DateTime
  content        String
  postIds        String[]
  topPostId      String
  status         String    @default("PENDING")
  postedAt       DateTime?
  tweetId        String?
  createdAt      DateTime  @default(now())
  digestImageUrl String?

  @@index([scheduledFor])
  @@index([status])
  @@map("DigestContent")
  @@ignore
}

model LegacyEmailEvent {
  id                String            @id
  notificationId    String
  event             EmailEventType
  timestamp         DateTime          @default(now())
  metadata          Json?
  EmailNotification LegacyEmailNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([notificationId])
  @@map("EmailEvent")
  @@ignore
}

model LegacyEmailNotification {
  id         String       @id
  userId     String
  type       EmailType
  subject    String
  postIds    String[]
  status     EmailStatus  @default(PENDING)
  messageId  String?
  error      String?
  sentAt     DateTime?
  createdAt  DateTime     @default(now())
  EmailEvent LegacyEmailEvent[]
  User       LegacyUser   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([type, sentAt])
  @@index([userId])
  @@map("EmailNotification")
  @@ignore
}

model LegacyMagicLink {
  id        String   @id
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
  @@map("MagicLink")
  @@ignore
}

model LegacyMetricPost {
  id            String           @id @default(cuid())
  postType      MetricPostType
  year          Int
  period        Int
  brand         Brand
  content       String
  chartImageUrl String?
  status        MetricPostStatus @default(DRAFT)
  tweetId       String?
  postedAt      DateTime?
  dataSnapshot  Json?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  attempts      Int              @default(0)
  lastError     String?
  lastAttemptAt DateTime?        @db.Timestamptz(6)
  approvedAt    DateTime?        @db.Timestamptz(6)
  approvedBy    String?

  @@unique([postType, year, period, brand])
  @@index([year, period])
  @@index([status])
  @@map("LegacyMetricPost")
  @@ignore
}

model LegacyPostingLog {
  id        String   @id @default(cuid())
  postType  String
  tweetId   String
  postIds   String[]
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@map("PostingLog")
  @@ignore
}

model LegacySubscriber {
  id          String    @id
  email       String    @unique
  language    Language  @default(EN)
  categories  String[]
  frequency   Frequency @default(DAILY)
  verified    Boolean   @default(false)
  verifyToken String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime

  @@index([verified])
  @@map("Subscriber")
  @@ignore
}

model LegacyUser {
  id                String              @id
  email             String              @unique
  name              String?
  avatarUrl         String?
  passwordHash      String?
  emailVerified     Boolean             @default(false)
  emailVerifyToken  String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  role              UserRole            @default(USER)
  Account           LegacyAccount[]
  EmailNotification LegacyEmailNotification[]
  SavedPost         LegacySavedPost[]
  Session           LegacySession[]
  UserPreference    LegacyUserPreference?
  XAccount          LegacyXAccount?

  @@index([emailVerified])
  @@map("User")
  @@ignore
}

model LegacySavedPost {
  id      String   @id
  userId  String
  postId  String
  savedAt DateTime @default(now())
  User    LegacyUser     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
  @@map("SavedPost")
  @@ignore
}

model LegacySession {
  id           String   @id
  userId       String
  sessionToken String   @unique
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  User         LegacyUser     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("Session")
  @@ignore
}

model LegacyUserPreference {
  id              String    @id
  userId          String    @unique
  brands          Brand[]
  topics          Topic[]
  digestFrequency Frequency @default(DAILY)
  alertsEnabled   Boolean   @default(true)
  alertThreshold  Int       @default(80)
  language        Language  @default(EN)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  User            LegacyUser      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("UserPreference")
  @@ignore
}

model LegacyXPublication {
  id                  String         @id
  postId              String         @unique
  status              XPublishStatus @default(PENDING)
  tweetId             String?
  tweetUrl            String?
  publishedAt         DateTime?
  imageSource         ImageSource    @default(NONE)
  mediaId             String?
  attempts            Int            @default(0)
  lastError           String?
  nextRetryAt         DateTime?
  likes               Int            @default(0)
  retweets            Int            @default(0)
  replies             Int            @default(0)
  impressions         Int            @default(0)
  engagementUpdatedAt DateTime?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime

  @@index([status, nextRetryAt], map: "idx_legacy_xpub_pending")
  @@map("XPublication")
  @@ignore
}

model LegacyXAccount {
  id             String   @id @default(cuid())
  userId         String   @unique
  xUserId        String   @unique
  username       String
  displayName    String?
  avatarUrl      String?
  accessToken    String
  refreshToken   String
  tokenExpiresAt DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  User           LegacyUser     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("XAccount")
  @@ignore
}
